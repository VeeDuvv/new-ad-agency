<!--

# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Vamsi Duvvuri

File: frontend/index.html

Need for this file (5th-grader explanation):
“Now our map has a big title block at the top showing the name of your toy set 
(like ‘Investor Relations’). It’s like the cover of your LEGO set box, so you 
always know which plan you’re looking at. Then all the steps hang down below it.”
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Blueprint Maker</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #controls {
            padding: 1rem;
            width: 25%;
            box-sizing: border-box;
        }

        #network {
            flex: 1;
            border-right: 1px solid #ccc;
        }

        #details {
            width: 25%;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        input,
        button {
            font-size: 1rem;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }

        details {
            margin-top: 1rem;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
        }

        pre {
            background: #f7f7f7;
            padding: 0.5rem;
        }
    </style>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Left panel: controls + raw JSON -->
    <div id="controls">
        <h1>Blueprint Maker</h1>
        <p>
            <label for="fnName">Enter function name:</label><br />
            <input type="text" id="fnName" placeholder="e.g. Creative Development" style="width:100%;" />
            <button id="runBtn">Decompose</button>
        </p>
        <details>
            <summary>Show Raw JSON</summary>
            <textarea id="result" readonly placeholder="Your decomposition will appear here..."></textarea>
        </details>
    </div>

    <!-- Center panel: graph -->
    <div id="network"></div>

    <!-- Right panel: details -->
    <div id="details">
        <h2>Node Details</h2>
        <pre id="detailsContent">Click a node to see details</pre>
    </div>

    <script>
        let nodeDetails = {};  // holds full objects by node id

        document.getElementById('runBtn').onclick = async () => {
            const fn = document.getElementById('fnName').value.trim();
            if (!fn) return alert('Please enter a function name.');

            // Call the API
            const res = await fetch('/decompose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ function_name: fn })
            });
            if (!res.ok) {
                document.getElementById('result').value = 'Error: ' + res.statusText;
                return;
            }

            const data = await res.json();
            document.getElementById('result').value = JSON.stringify(data, null, 2);
            buildGraph(data, fn);
        };

        function buildGraph(data, functionName) {
            const nodes = [];
            const edges = [];
            nodeDetails = {};  // reset

            // 1. Add root node for the function name
            const rootId = 'root';
            nodes.push({
                id: rootId,
                label: functionName,
                group: 'root'
            });
            nodeDetails[rootId] = { name: functionName, type: 'function' };

            // 2. Add processes, activities, tasks
            data.processes.forEach((proc, pIdx) => {
                const pid = `proc${pIdx}`;
                nodes.push({ id: pid, label: proc.name, group: 'process' });
                edges.push({ from: rootId, to: pid });
                nodeDetails[pid] = proc;

                proc.activities.forEach((act, aIdx) => {
                    const aid = `${pid}act${aIdx}`;
                    nodes.push({ id: aid, label: act.name, group: 'activity' });
                    edges.push({ from: pid, to: aid });
                    nodeDetails[aid] = act;

                    act.tasks.forEach((task, tIdx) => {
                        const tid = `${aid}task${tIdx}`;
                        nodes.push({ id: tid, label: task.name, group: 'task' });
                        edges.push({ from: aid, to: tid });
                        nodeDetails[tid] = task;
                    });
                });
            });

            // 3. Render with vis-network
            const container = document.getElementById('network');
            const visData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                groups: {
                    root: { color: { background: '#FFA500' }, shape: 'box', font: { size: 24 } },
                    process: { color: { background: '#FFD700' }, shape: 'box' },
                    activity: { color: { background: '#87CEFA' }, shape: 'ellipse' },
                    task: { color: { background: '#90EE90' }, shape: 'dot' }
                },
                layout: { hierarchical: { direction: 'UD', sortMethod: 'directed' } },
                physics: false,
                interaction: { hover: true }
            };
            const network = new vis.Network(container, visData, options);

            // 4. Show details on click
            network.on("selectNode", params => {
                const id = params.nodes[0];
                const info = nodeDetails[id] || { error: "No details available" };
                document.getElementById('detailsContent').textContent = JSON.stringify(info, null, 2);
            });
        }
    </script>
</body>

</html>