<!--
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Vamsi Duvvuri

File: frontend/index.html

Need for this file (5th-grader explanation):
“Here’s the control panel for our Blueprint Maker. On the left you type the name 
of the big job you want to map (like ‘make ads’), choose whether you want to follow 
the APQC or eTOM rulebook, and click ‘Decompose.’ In the middle you see the map 
of steps with a little legend on top. On the right, when you click any step, 
you’ll see exactly what that step is—its name, who’s responsible, what tools 
they use, what they make, and how long it takes—in a nice list. If you want more 
detail, click the ‘Drill Down’ button and you’ll get the 3–6 tiny steps that 
make up that step, shown right below. No confusing extra stuff—just the step 
you clicked!”
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Blueprint Maker</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #controls {
            padding: 1rem;
            width: 25%;
            box-sizing: border-box;
        }

        #graph-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #ccc;
        }

        #network {
            width: 100%;
            height: 100%;
        }

        #details {
            width: 25%;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        input,
        button {
            font-size: 1rem;
            padding: 0.5rem;
            margin: 0.25rem 0;
            width: 100%;
            box-sizing: border-box;
        }

        #result {
            width: 100%;
            height: 30vh;
            font-family: monospace;
            margin-top: 0.5rem;
            overflow-y: auto;
        }

        dl {
            margin: 0;
        }

        dt {
            font-weight: bold;
            margin-top: 0.5em;
        }

        dd {
            margin: 0 0 0.5em 1em;
        }

        .legend {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 0.5rem;
            font-size: 0.9rem;
            z-index: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 6px;
        }
    </style>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Left panel: controls + raw JSON -->
    <div id="controls">
        <h1>Blueprint Maker</h1>
        <p>
            <label for="fnName">Enter function name:</label><br />
            <input type="text" id="fnName" placeholder="e.g. Creative Development" />
        </p>
        <p>
            <label>Choose framework:</label><br />
            <input type="radio" id="apqc" name="framework" value="APQC" checked>
            <label for="apqc">APQC</label><br />
            <input type="radio" id="etom" name="framework" value="eTOM">
            <label for="etom">eTOM</label>
        </p>
        <button id="runBtn">Decompose</button>
        <details style="margin-top:1rem;">
            <summary>Show Raw JSON</summary>
            <textarea id="result" readonly placeholder="Your decomposition will appear here..."></textarea>
        </details>
    </div>

    <!-- Center panel: graph + legend -->
    <div id="graph-container">
        <div class="legend">
            <strong>Legend</strong>
            <div class="legend-item"><span class="legend-color" style="background:#FFA500;"></span>Function (L0)</div>
            <div class="legend-item"><span class="legend-color" style="background:#FFD700;"></span>Process (L1)</div>
            <div class="legend-item"><span class="legend-color" style="background:#87CEFA;"></span>Activity (L2)</div>
            <div class="legend-item"><span class="legend-color" style="background:#90EE90;"></span>Task (L3)</div>
            <div class="legend-item"><span class="legend-color" style="background:#D8BFD8;"></span>Subtask (L4)</div>
        </div>
        <div id="network"></div>
    </div>

    <!-- Right panel: details + drill-down -->
    <div id="details">
        <h2>Node Details</h2>
        <div id="detailsContent">Click a node to see details</div>
        <button id="drillBtn" disabled style="margin-top:1em;">Drill Down</button>
        <div id="drillResults" style="margin-top:1em; font-size:0.9rem;"></div>
    </div>

    <script>
        let nodeDetails = {};
        let currentFocus = null;

        // Decompose button handler
        document.getElementById('runBtn').onclick = async () => {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;
            const fn = document.getElementById('fnName').value.trim();
            if (!fn) { alert('Please enter a function name.'); btn.disabled = false; return; }
            const framework = document.querySelector('input[name="framework"]:checked').value;
            try {
                const res = await fetch('/decompose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ function_name: fn, framework })
                });
                if (!res.ok) {
                    document.getElementById('result').value = 'Error: ' + res.statusText;
                } else {
                    const data = await res.json();
                    document.getElementById('result').value = JSON.stringify(data, null, 2);
                    buildGraph(data, fn);
                }
            } catch (err) {
                document.getElementById('result').value = 'Fetch error: ' + err;
            } finally {
                btn.disabled = false;
            }
        };

        // Build the graph
        function buildGraph(data, functionName) {
            nodeDetails = {};
            currentFocus = null;
            const nodes = [], edges = [];

            // L0 root node
            const rootId = 'root';
            nodes.push({ id: rootId, label: functionName, group: 'root' });
            nodeDetails[rootId] = { name: functionName, type: 'Function' };

            // Recursive helper for L1–L4
            function recurse(parentId, items, level) {
                items.forEach((item, idx) => {
                    const id = `${parentId}-${level}-${idx}`;
                    const group = level === 'L1'
                        ? 'process'
                        : level === 'L2'
                            ? 'activity'
                            : level === 'L3'
                                ? 'task'
                                : 'subtask';
                    nodes.push({ id, label: item.name, group });
                    edges.push({ from: parentId, to: id });
                    nodeDetails[id] = {
                        name: item.name,
                        role: item.role,
                        tools: item.tools,
                        deliverable: item.deliverable,
                        time_estimate: item.time_estimate,
                        type: group
                    };
                    if (item.subitems && level !== 'L4') {
                        recurse(id, item.subitems, `L${+level.slice(1) + 1}`);
                    }
                });
            }

            // Start at process level (L1)
            recurse(rootId, data.levels.L1 || [], 'L1');

            // Render with vis-network
            const container = document.getElementById('network');
            const visData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                groups: {
                    root: { color: '#FFA500', shape: 'box', font: { size: 24, multi: true }, widthConstraint: { maximum: 250 } },
                    process: { color: '#FFD700', shape: 'box', font: { multi: true }, widthConstraint: { maximum: 200 } },
                    activity: { color: '#87CEFA', shape: 'ellipse', font: { multi: true }, widthConstraint: { maximum: 180 } },
                    task: { color: '#90EE90', shape: 'dot' },
                    subtask: { color: '#D8BFD8', shape: 'triangle' }
                },
                layout: {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed',
                        levelSeparation: 150,
                        nodeSpacing: 200,
                        treeSpacing: 200
                    }
                },
                physics: false,
                interaction: { hover: true }
            };
            const network = new vis.Network(container, visData, options);

            // Drill Down button and results
            const drillBtn = document.getElementById('drillBtn');
            const drillResults = document.getElementById('drillResults');

            network.on("selectNode", params => {
                currentFocus = params.nodes[0];
                const info = nodeDetails[currentFocus] || {};
                renderDetails(info);
                drillResults.innerHTML = '';
                drillBtn.disabled = !(info.name && info.role && info.tools);
            });

            drillBtn.onclick = async () => {
                drillBtn.disabled = true;
                const info = nodeDetails[currentFocus];
                try {
                    let tools = info.tools;
                    if (typeof tools === 'string') {
                        tools = tools.split(',').map(s => s.trim());
                    }
                    const payload = {
                        name: info.name,
                        role: info.role,
                        tools: tools,
                        deliverable: info.deliverable,
                        time_estimate: info.time_estimate
                    };
                    const res = await fetch('/drilldown', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        drillResults.textContent = 'Error: ' + res.statusText;
                    } else {
                        const { subtasks } = await res.json();
                        drillResults.innerHTML = '<ul>' + subtasks.map(st =>
                            `<li><strong>${st.name}</strong> — ${st.role} (tools: ${st.tools.join(", ")})</li>`
                        ).join('') + '</ul>';
                    }
                } catch (e) {
                    drillResults.textContent = 'Fetch error: ' + e;
                } finally {
                    drillBtn.disabled = false;
                }
            };
        }

        // Render node details
        function renderDetails(info) {
            const fields = [
                ['Type', info.type || ''],
                ['Name', info.name || ''],
                ['Role', info.role || ''],
                ['Tools', Array.isArray(info.tools) ? info.tools.join(', ') : info.tools || ''],
                ['Deliverable', info.deliverable || ''],
                ['Time Estimate', info.time_estimate || '']
            ];
            let html = '<dl>';
            fields.forEach(([label, val]) => {
                if (val) html += `<dt>${label}:</dt><dd>${val}</dd>`;
            });
            html += '</dl>';
            document.getElementById('detailsContent').innerHTML = html;
        }
    </script>
</body>

</html>