<!--
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Vamsi Duvvuri

File: frontend/index.html

Need for this file (5th-grader explanation):
“This is our magic webpage. First, you type the name of the big job 
(like ‘Media Buying & Execution’). Then you choose which rulebook 
(APQC or eTOM) you want to follow—just two simple radio buttons. 
Click ‘Decompose’ and watch the plan appear below as a hidden JSON 
note, a colorful map of blocks and dots, and when you click any block, 
the panel on the right tells you all the juicy details!”
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Blueprint Maker</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #controls {
            padding: 1rem;
            width: 25%;
            box-sizing: border-box;
        }

        #network {
            flex: 1;
            border-right: 1px solid #ccc;
        }

        #details {
            width: 25%;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        input,
        button {
            font-size: 1rem;
            padding: 0.5rem;
            margin: 0.25rem 0;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
        }

        pre {
            background: #f7f7f7;
            padding: 0.5rem;
        }
    </style>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <div id="controls">
        <h1>Blueprint Maker</h1>
        <p>
            <label for="fnName">Enter function name:</label><br />
            <input type="text" id="fnName" placeholder="e.g. Creative Development" style="width:100%;" />
        </p>
        <p>
            <label>Choose framework:</label><br />
            <input type="radio" id="apqc" name="framework" value="APQC" checked>
            <label for="apqc">APQC</label><br />
            <input type="radio" id="etom" name="framework" value="eTOM">
            <label for="etom">eTOM</label>
        </p>
        <button id="runBtn">Decompose</button>
        <details style="margin-top:1rem;">
            <summary>Show Raw JSON</summary>
            <textarea id="result" readonly placeholder="Your decomposition will appear here..."></textarea>
        </details>
    </div>

    <div id="network"></div>

    <div id="details">
        <h2>Node Details</h2>
        <pre id="detailsContent">Click a node to see details</pre>
    </div>

    <script>
        let nodeDetails = {};

        document.getElementById('runBtn').onclick = async () => {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;

            const fn = document.getElementById('fnName').value.trim();
            if (!fn) { alert('Please enter a function name.'); btn.disabled = false; return; }

            const framework = document.querySelector('input[name="framework"]:checked').value;

            try {
                const res = await fetch('/decompose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ function_name: fn, framework })
                });

                if (!res.ok) {
                    document.getElementById('result').value = 'Error: ' + res.statusText;
                } else {
                    const data = await res.json();
                    document.getElementById('result').value = JSON.stringify(data, null, 2);
                    buildGraph(data, fn);
                }
            } catch (err) {
                document.getElementById('result').value = 'Fetch error: ' + err;
            } finally {
                btn.disabled = false;
            }
        };

        function buildGraph(data, functionName) {
            const nodes = [], edges = [];
            nodeDetails = {};

            const rootId = 'root';
            nodes.push({ id: rootId, label: functionName, group: 'root' });
            nodeDetails[rootId] = { name: functionName, type: 'function' };

            data.levels.L1.forEach((proc, i) => {
                const pid = `L1-${i}`;
                nodes.push({ id: pid, label: proc.name, group: 'process' });
                edges.push({ from: rootId, to: pid });
                nodeDetails[pid] = proc;

                // L2, L3, L4 nested (assuming the JSON structure matches)
                proc.subitems && proc.subitems.forEach((act, j) => {
                    const aid = `${pid}-L2-${j}`;
                    nodes.push({ id: aid, label: act.name, group: 'activity' });
                    edges.push({ from: pid, to: aid });
                    nodeDetails[aid] = act;

                    act.subitems && act.subitems.forEach((task, k) => {
                        const tid = `${aid}-L3-${k}`;
                        nodes.push({ id: tid, label: task.name, group: 'task' });
                        edges.push({ from: aid, to: tid });
                        nodeDetails[tid] = task;

                        task.subitems && task.subitems.forEach((sub, m) => {
                            const sid = `${tid}-L4-${m}`;
                            nodes.push({ id: sid, label: sub.name, group: 'subtask' });
                            edges.push({ from: tid, to: sid });
                            nodeDetails[sid] = sub;
                        });
                    });
                });
            });

            const container = document.getElementById('network');
            const visData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                groups: {
                    root: { color: '#FFA500', shape: 'box', font: { size: 24 } },
                    process: { color: '#FFD700', shape: 'box' },
                    activity: { color: '#87CEFA', shape: 'ellipse' },
                    task: { color: '#90EE90', shape: 'dot' },
                    subtask: { color: '#D8BFD8', shape: 'triangle' }
                },
                layout: { hierarchical: { direction: 'UD', sortMethod: 'directed' } },
                physics: false,
                interaction: { hover: true }
            };
            const network = new vis.Network(container, visData, options);

            network.on("selectNode", params => {
                const id = params.nodes[0];
                const info = nodeDetails[id] || { error: "No details available" };
                document.getElementById('detailsContent').textContent = JSON.stringify(info, null, 2);
            });
        }
    </script>
</body>

</html>