<!--
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Vamsi Duvvuri

File: frontend/index.html

Need for this file (5th-grader explanation):
“Here’s the control panel for our Blueprint Maker. On the left you type the name 
of the big job you want to map (like ‘make ads’), choose whether you want to follow 
the APQC or eTOM rulebook, and click ‘Decompose.’ In the middle you see the map 
of steps with a little legend on top. On the right, when you click any step, 
you’ll see exactly what that step is—its name, who’s responsible, what tools 
they use, what they make, and how long it takes—in a nice list. If you want more 
detail, click the ‘Drill Down’ button and you’ll get the 3–6 tiny steps that 
make up that step, shown right below. No confusing extra stuff—just the step 
you clicked!”
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Blueprint Maker</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #controls {
            padding: 1rem;
            width: 25%;
            box-sizing: border-box;
        }

        #graph-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #ccc;
        }

        #network {
            width: 100%;
            height: 100%;
        }

        #details {
            width: 25%;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #drillResults ul {
            list-style: disc inside;
            margin: 0.5em 0;
            padding: 0 0.5em;
            background: #f7f7f7;
            border-radius: 4px;
        }

        #drillResults li {
            margin-left: 0.5em;
        }

        #codegenResult {
            font-family: monospace;
            max-height: 30vh;
            overflow-y: auto;
        }

        input,
        button {
            font-size: 1rem;
            padding: 0.5rem;
            margin: 0.25rem 0;
            width: 100%;
            box-sizing: border-box;
        }

        #result {
            width: 100%;
            height: 30vh;
            font-family: monospace;
            margin-top: 0.5rem;
            overflow-y: auto;
        }

        dl {
            margin: 0;
        }

        dt {
            font-weight: bold;
            margin-top: 0.5em;
        }

        dd {
            margin: 0 0 0.5em 1em;
        }

        .legend {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 0.5rem;
            font-size: 0.9rem;
            z-index: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 6px;
        }
    </style>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Left panel: controls + raw JSON -->
    <div id="controls">
        <h1>Blueprint Maker</h1>
        <p>
            <label for="fnName">Enter function name:</label><br />
            <input type="text" id="fnName" placeholder="e.g. Creative Development" />
        </p>
        <p>
            <label>Choose framework:</label><br />
            <input type="radio" id="apqc" name="framework" value="APQC" checked>
            <label for="apqc">APQC</label><br />
            <input type="radio" id="etom" name="framework" value="eTOM">
            <label for="etom">eTOM</label>
        </p>
        <button id="runBtn">Decompose</button>
        <details style="margin-top:1rem;">
            <summary>Show Raw JSON</summary>
            <textarea id="result" readonly placeholder="Your decomposition will appear here..."></textarea>
        </details>
    </div>

    <!-- Center panel: graph + legend -->
    <div id="graph-container">
        <div class="legend">
            <strong>Legend</strong>
            <div class="legend-item"><span class="legend-color" style="background:#FFA500;"></span>Function (L0)</div>
            <div class="legend-item"><span class="legend-color" style="background:#FFD700;"></span>Process (L1)</div>
            <div class="legend-item"><span class="legend-color" style="background:#87CEFA;"></span>Activity (L2)</div>
            <div class="legend-item"><span class="legend-color" style="background:#90EE90;"></span>Task (L3)</div>
            <div class="legend-item"><span class="legend-color" style="background:#D8BFD8;"></span>Subtask (L4)</div>
        </div>
        <div id="network"></div>
    </div>

    <!-- Right panel: details + drill-down -->
    <div id="details">
        <h2>Node Details</h2>
        <div id="detailsContent">Click a node to see details</div>
        <button id="drillBtn" disabled style="margin-top:1em;">Drill Down</button>
        <pre id="drillResults" style="
       margin-top:1em; 
       font-size:0.9rem; 
       background:#f7f7f7; 
       padding:0.5rem; 
       border-radius:4px;
       white-space: pre-wrap;
     "></pre>


        <!-- CodeGen controls -->
        <button id="codegenBtn" disabled style="margin-top:1em;">Generate Code</button>
        <pre id="codegenResult" style="margin-top:1em; background:#f7f7f7; padding:0.5rem;"></pre>
    </div>

    <script>
        let nodeDetails = {}, currentFocus = null, network = null;

        const runBtn = document.getElementById('runBtn');
        const drillBtn = document.getElementById('drillBtn');
        const drillResults = document.getElementById('drillResults');
        const codegenBtn = document.getElementById('codegenBtn');
        const codegenResult = document.getElementById('codegenResult');

        function buildGraph(data, functionName) {
            nodeDetails = {};
            currentFocus = null;
            const nodes = [], edges = [];

            // root node
            const rootId = 'root';
            nodes.push({ id: rootId, label: functionName, group: 'root' });
            nodeDetails[rootId] = { name: functionName, type: 'Function' };

            // recurse helper…
            function recurse(parentId, items, lvl) {
                items.forEach((item, i) => {
                    const id = `${parentId}-${lvl}-${i}`;
                    const grp = lvl === 'L1' ? 'process' : lvl === 'L2' ? 'activity' : lvl === 'L3' ? 'task' : 'subtask';
                    nodes.push({ id, label: item.name, group: grp });
                    edges.push({ from: parentId, to: id });
                    nodeDetails[id] = {
                        name: item.name,
                        role: item.role,
                        tools: item.tools,
                        deliverable: item.deliverable,
                        time_estimate: item.time_estimate,
                        type: grp
                    };
                    if (item.subitems && lvl !== 'L4') recurse(id, item.subitems, `L${+lvl.slice(1) + 1}`);
                });
            }
            recurse(rootId, data.levels.L1 || [], 'L1');

            // render network
            const container = document.getElementById('network');
            const visData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = { /* … your existing options … */ };
            network = new vis.Network(container, visData, options);

            // selection logic
            network.on("selectNode", params => {
                currentFocus = params.nodes[0];
                const info = nodeDetails[currentFocus] || {};
                renderDetails(info);
                drillResults.innerHTML = '';
                codegenResult.textContent = '';
                drillBtn.disabled = !(info.name && info.role && info.tools);
                codegenBtn.disabled = drillBtn.disabled;
            });
        }

        runBtn.onclick = async () => {
            runBtn.disabled = true;
            const fn = document.getElementById('fnName').value.trim();
            if (!fn) { alert('Enter a function name'); runBtn.disabled = false; return; }
            const framework = document.querySelector('input[name="framework"]:checked').value;

            const res = await fetch('/api/agent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    agent: 'func_decomp',
                    payload: { function_name: fn, framework }
                })
            });
            const { result } = await res.json();
            document.getElementById('result').value = JSON.stringify(result, null, 2);
            buildGraph(result, fn);
            runBtn.disabled = false;
        };

        drillBtn.onclick = async () => {
            drillBtn.disabled = true;
            const info = nodeDetails[currentFocus];

            // Normalize tools into an array
            let tools = info.tools;
            if (typeof tools === 'string') {
                tools = tools.split(',').map(s => s.trim());
            }

            // *** THIS MUST be exactly '/api/agent' ***
            const url = '/api/agent';

            // And the body must look like this:
            const payload = {
                agent: 'micro_decomp',
                payload: {
                    name: info.name,
                    role: info.role,
                    tools: tools,
                    deliverable: info.deliverable,
                    time_estimate: info.time_estimate
                }
            };

            console.log('Drill-down request:', url, payload);

            try {
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                // Inspect the raw JSON so we know what shape we got back
                const body = await resp.json();
                console.log('Drill-down response body:', body);

                const subtasks = body.result?.subtasks ?? [];
                drillResults.textContent =
                    subtasks.map(st =>
                        `${st.name} — ${st.role} (tools: ${st.tools.join(', ')})`
                    ).join('\n');
            } catch (e) {
                drillResults.textContent = 'Error: ' + e;
            } finally {
                drillBtn.disabled = false;
            }
        };

        codegenBtn.onclick = async () => {
            codegenBtn.disabled = true;
            const info = nodeDetails[currentFocus];
            // normalize tools
            let tools = info.tools;
            if (typeof tools === 'string') tools = tools.split(',').map(s => s.trim());

            try {
                const resp = await fetch('/api/agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent: 'codegen',
                        payload: {
                            name: info.name,
                            role: info.role,
                            tools: tools,
                            deliverable: info.deliverable,
                            time_estimate: info.time_estimate
                        }
                    })
                });
                const body = await resp.json();
                // two possible shapes, pick whichever applies
                const code = body.result?.code ?? body.code ?? '';
                codegenResult.textContent = code;
            } catch (e) {
                codegenResult.textContent = 'Error: ' + e;
            } finally {
                codegenBtn.disabled = false;
            }
        };

        // Render details (unchanged)
        function renderDetails(info) {
            const fields = [
                ['Type', info.type || ''],
                ['Name', info.name || ''],
                ['Role', info.role || ''],
                ['Tools', Array.isArray(info.tools) ? info.tools.join(', ') : info.tools || ''],
                ['Deliverable', info.deliverable || ''],
                ['Time Estimate', info.time_estimate || '']
            ];
            let html = '<dl>';
            for (const [lbl, val] of fields) {
                if (val) html += `<dt>${lbl}:</dt><dd>${val}</dd>`;
            }
            html += '</dl>';
            document.getElementById('detailsContent').innerHTML = html;
        }
    </script>
</body>

</html>