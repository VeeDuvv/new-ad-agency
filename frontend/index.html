<!--
SPDX-License-Identifier: MIT
Copyright (c) 2025 Vamsi Duvvuri

File: frontend/index.html

Need for this file (5th-grader explanation):
“This is the big control panel for our Blueprint Maker. On the left you can type
in the name of the thing you want to break down (like ‘make ads’) and click the
‘Decompose’ button. The page shows you two ways to see the plan: a hidden block
you can open to read the raw steps in JSON, and a colorful map in the middle
where each box or dot is a step you can click. When you click a step, the right
panel tells you all the details—like who does it, what tools they use, and how
long it takes. And while it’s thinking, the button takes a nap so you don’t
press it twice by accident!”
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Blueprint Maker</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #controls {
            padding: 1rem;
            width: 25%;
            box-sizing: border-box;
        }

        #network {
            flex: 1;
            border-right: 1px solid #ccc;
        }

        #details {
            width: 25%;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        input,
        button {
            font-size: 1rem;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }

        details {
            margin-top: 1rem;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
        }

        pre {
            background: #f7f7f7;
            padding: 0.5rem;
        }
    </style>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Left panel: controls + raw JSON -->
    <div id="controls">
        <h1>Blueprint Maker</h1>
        <p>
            <label for="fnName">Enter function name:</label><br />
            <input type="text" id="fnName" placeholder="e.g. Creative Development" style="width:100%;" />
            <button id="runBtn">Decompose</button>
        </p>
        <details>
            <summary>Show Raw JSON</summary>
            <textarea id="result" readonly placeholder="Your decomposition will appear here..."></textarea>
        </details>
    </div>

    <!-- Center panel: graph -->
    <div id="network"></div>

    <!-- Right panel: details -->
    <div id="details">
        <h2>Node Details</h2>
        <pre id="detailsContent">Click a node to see details</pre>
    </div>

    <script>
        let nodeDetails = {};

        document.getElementById('runBtn').onclick = async () => {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;  // prevent double-clicks

            const fn = document.getElementById('fnName').value.trim();
            if (!fn) {
                alert('Please enter a function name.');
                btn.disabled = false;
                return;
            }

            try {
                const res = await fetch('/decompose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ function_name: fn })
                });

                if (!res.ok) {
                    document.getElementById('result').value = 'Error: ' + res.statusText;
                } else {
                    const data = await res.json();
                    document.getElementById('result').value = JSON.stringify(data, null, 2);
                    buildGraph(data, fn);
                }
            } catch (err) {
                document.getElementById('result').value = 'Fetch error: ' + err;
            } finally {
                btn.disabled = false;  // re-enable when done
            }
        };

        function buildGraph(data, functionName) {
            const nodes = [];
            const edges = [];
            nodeDetails = {};

            // root node for the function name
            const rootId = 'root';
            nodes.push({ id: rootId, label: functionName, group: 'root' });
            nodeDetails[rootId] = { name: functionName, type: 'function' };

            data.processes.forEach((proc, pIdx) => {
                const pid = `proc${pIdx}`;
                nodes.push({ id: pid, label: proc.name, group: 'process' });
                edges.push({ from: rootId, to: pid });
                nodeDetails[pid] = proc;

                proc.activities.forEach((act, aIdx) => {
                    const aid = `${pid}act${aIdx}`;
                    nodes.push({ id: aid, label: act.name, group: 'activity' });
                    edges.push({ from: pid, to: aid });
                    nodeDetails[aid] = act;

                    act.tasks.forEach((task, tIdx) => {
                        const tid = `${aid}task${tIdx}`;
                        nodes.push({ id: tid, label: task.name, group: 'task' });
                        edges.push({ from: aid, to: tid });
                        nodeDetails[tid] = task;
                    });
                });
            });

            const container = document.getElementById('network');
            const visData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
            const options = {
                groups: {
                    root: { color: { background: '#FFA500' }, shape: 'box', font: { size: 24 } },
                    process: { color: { background: '#FFD700' }, shape: 'box' },
                    activity: { color: { background: '#87CEFA' }, shape: 'ellipse' },
                    task: { color: { background: '#90EE90' }, shape: 'dot' }
                },
                layout: { hierarchical: { direction: 'UD', sortMethod: 'directed' } },
                physics: false,
                interaction: { hover: true }
            };
            const network = new vis.Network(container, visData, options);

            network.on("selectNode", params => {
                const id = params.nodes[0];
                const info = nodeDetails[id] || { error: "No details available" };
                document.getElementById('detailsContent').textContent =
                    JSON.stringify(info, null, 2);
            });
        }
    </script>
</body>

</html>