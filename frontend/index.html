<!--
# SPDX-License-Identifier: MIT
# Copyright (c) 2025 Vamsi Duvvuri

File: frontend/index.html

Need for this file (5th-grader explanation):
“Here’s the control panel for our Blueprint Maker. On the left you type the name 
of the big job you want to map (like ‘make ads’), choose whether you want to follow 
the APQC or eTOM rulebook, and click ‘Decompose.’ In the middle you see the map 
of steps with a little legend on top. On the right, when you click any step, 
you’ll see exactly what that step is—its name, who’s responsible, what tools 
they use, what they make, and how long it takes—in a nice list. No confusing 
extra stuff from the children, just the step you clicked!”

We also fixed our internal names so each step’s ID includes its parent, so every
node is unique and you won’t get collisions anymore.
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Blueprint Maker</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
        }

        #controls {
            padding: 1rem;
            width: 25%;
            box-sizing: border-box;
        }

        #graph-container {
            flex: 1;
            position: relative;
            border-right: 1px solid #ccc;
        }

        #network {
            width: 100%;
            height: 100%;
        }

        #details {
            width: 25%;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
        }

        input,
        button {
            font-size: 1rem;
            padding: 0.5rem;
            margin: 0.25rem 0;
            width: 100%;
            box-sizing: border-box;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            margin-top: 0.5rem;
        }

        dl {
            margin: 0;
        }

        dt {
            font-weight: bold;
            margin-top: 0.5em;
        }

        dd {
            margin: 0 0 0.5em 1em;
        }

        .legend {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            padding: 0.5rem;
            font-size: 0.9rem;
            z-index: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 6px;
        }
    </style>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>

<body>
    <!-- Left panel: controls + raw JSON -->
    <div id="controls">
        <h1>Blueprint Maker</h1>
        <p>
            <label for="fnName">Enter function name:</label><br />
            <input type="text" id="fnName" placeholder="e.g. Creative Development" />
        </p>
        <p>
            <label>Choose framework:</label><br />
            <input type="radio" id="apqc" name="framework" value="APQC" checked>
            <label for="apqc">APQC</label><br />
            <input type="radio" id="etom" name="framework" value="eTOM">
            <label for="etom">eTOM</label>
        </p>
        <button id="runBtn">Decompose</button>
        <details style="margin-top:1rem;">
            <summary>Show Raw JSON</summary>
            <textarea id="result" readonly placeholder="Your decomposition will appear here..."></textarea>
        </details>
    </div>

    <!-- Center panel: graph + legend -->
    <div id="graph-container">
        <div class="legend">
            <strong>Legend</strong>
            <div class="legend-item"><span class="legend-color" style="background:#FFA500;"></span>Function (L0)</div>
            <div class="legend-item"><span class="legend-color" style="background:#FFD700;"></span>Process (L1)</div>
            <div class="legend-item"><span class="legend-color" style="background:#87CEFA;"></span>Activity (L2)</div>
            <div class="legend-item"><span class="legend-color" style="background:#90EE90;"></span>Task (L3)</div>
            <div class="legend-item"><span class="legend-color" style="background:#D8BFD8;"></span>Subtask (L4)</div>
        </div>
        <div id="network"></div>
    </div>

    <!-- Right panel: details -->
    <div id="details">
        <h2>Node Details</h2>
        <div id="detailsContent">Click a node to see details</div>
    </div>

    <script>
        let nodeDetails = {};

        document.getElementById('runBtn').onclick = async () => {
            const btn = document.getElementById('runBtn');
            btn.disabled = true;

            const fn = document.getElementById('fnName').value.trim();
            if (!fn) {
                alert('Please enter a function name.');
                btn.disabled = false;
                return;
            }

            const framework = document.querySelector('input[name="framework"]:checked').value;

            try {
                const res = await fetch('/decompose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ function_name: fn, framework })
                });

                if (!res.ok) {
                    document.getElementById('result').value = 'Error: ' + res.statusText;
                } else {
                    const data = await res.json();
                    document.getElementById('result').value = JSON.stringify(data, null, 2);
                    buildGraph(data, fn);
                }
            } catch (err) {
                document.getElementById('result').value = 'Fetch error: ' + err;
            } finally {
                btn.disabled = false;
            }
        };

        function buildGraph(data, functionName) {
            nodeDetails = {};
            const nodes = [];
            const edges = [];

            // L0: Function node
            const rootId = 'root';
            nodes.push({ id: rootId, label: functionName, group: 'root' });
            nodeDetails[rootId] = { name: functionName, type: 'Function' };

            // Recursive helper for L1–L4 with unique IDs
            function recurse(parentId, items, level) {
                items.forEach((item, idx) => {
                    const id = `${parentId}-${level}-${idx}`;
                    const group = level === 'L1'
                        ? 'process'
                        : level === 'L2'
                            ? 'activity'
                            : level === 'L3'
                                ? 'task'
                                : 'subtask';
                    nodes.push({ id, label: item.name, group });
                    edges.push({ from: parentId, to: id });
                    nodeDetails[id] = {
                        name: item.name,
                        role: item.role,
                        tools: item.tools,
                        deliverable: item.deliverable,
                        time_estimate: item.time_estimate,
                        type: group
                    };
                    if (item.subitems && level !== 'L4') {
                        recurse(id, item.subitems, `L${+level.slice(1) + 1}`);
                    }
                });
            }

            // Start at L1 (processes)
            recurse(rootId, data.levels.L1 || [], 'L1');

            // Render with vis-network
            const container = document.getElementById('network');
            const visData = {
                nodes: new vis.DataSet(nodes),
                edges: new vis.DataSet(edges)
            };
            const options = {
                groups: {
                    root: { color: '#FFA500', shape: 'box', font: { size: 24 } },
                    process: { color: '#FFD700', shape: 'box' },
                    activity: { color: '#87CEFA', shape: 'ellipse' },
                    task: { color: '#90EE90', shape: 'dot' },
                    subtask: { color: '#D8BFD8', shape: 'triangle' }
                },
                layout: { hierarchical: { direction: 'UD', sortMethod: 'directed' } },
                physics: false,
                interaction: { hover: true }
            };
            const network = new vis.Network(container, visData, options);

            network.on("selectNode", params => {
                const id = params.nodes[0];
                const info = nodeDetails[id] || {};
                renderDetails(info);
            });
        }

        function renderDetails(info) {
            const fields = [
                ['Type', info.type || ''],
                ['Name', info.name || ''],
                ['Role', info.role || ''],
                ['Tools', Array.isArray(info.tools) ? info.tools.join(', ') : info.tools || ''],
                ['Deliverable', info.deliverable || ''],
                ['Time Estimate', info.time_estimate || '']
            ];

            let html = '<dl>';
            for (const [label, val] of fields) {
                if (val) {
                    html += `<dt>${label}:</dt><dd>${val}</dd>`;
                }
            }
            html += '</dl>';
            document.getElementById('detailsContent').innerHTML = html;
        }
    </script>
</body>

</html>